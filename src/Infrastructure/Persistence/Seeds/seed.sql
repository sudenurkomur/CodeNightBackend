-- ============================================================
-- CodeNight Seed Data — Case 2 CSV'lerden normalize edilmiştir
-- Deterministik UUID'ler kullanılır (FK tutarlılığı için)
-- ============================================================

BEGIN;

-- Mevcut verileri temizle (FK sırası ile)
TRUNCATE TABLE triggered_challenges CASCADE;
TRUNCATE TABLE notifications CASCADE;
TRUNCATE TABLE points_ledger CASCADE;
TRUNCATE TABLE badge_awards CASCADE;
TRUNCATE TABLE challenge_awards CASCADE;
TRUNCATE TABLE challenge_decisions CASCADE;
TRUNCATE TABLE user_states CASCADE;
TRUNCATE TABLE events CASCADE;
TRUNCATE TABLE challenges CASCADE;
TRUNCATE TABLE badges CASCADE;
TRUNCATE TABLE tracks CASCADE;
TRUNCATE TABLE artists CASCADE;
TRUNCATE TABLE users CASCADE;

-- ============================================================
-- 1) USERS  (users.csv + user_state.csv)
--    CSV'de surname yok → makul soyadlar eklendi
--    segment (STUDENT/YOUNG_PRO) → role = USER
-- ============================================================
INSERT INTO users (user_id, name, surname, city, role) VALUES
  ('00000000-0000-0000-0001-000000000001', 'Ayşe',  'Yılmaz', 'Istanbul', 'USER'),
  ('00000000-0000-0000-0001-000000000002', 'Ali',   'Demir',  'Ankara',  'USER'),
  ('00000000-0000-0000-0001-000000000003', 'Deniz', 'Kaya',   'Izmir',   'USER'),
  ('00000000-0000-0000-0001-000000000004', 'Mert',  'Özkan',  'Bursa',   'USER'),
  ('00000000-0000-0000-0001-000000000005', 'Ece',   'Aydın',  'Antalya', 'USER');

-- ============================================================
-- 2) ARTISTS  (artists.csv)
-- ============================================================
INSERT INTO artists (artist_id, artist_name, genre) VALUES
  ('00000000-0000-0000-0004-000000000001', 'Elektrik Kedi', 'POP'),
  ('00000000-0000-0000-0004-000000000002', 'Gece Sürüşü',  'ROCK'),
  ('00000000-0000-0000-0004-000000000003', 'LoFi Martı',   'LOFI'),
  ('00000000-0000-0000-0004-000000000004', 'Bassline 34',  'ELECTRONIC');

-- ============================================================
-- 3) TRACKS  (tracks.csv)
-- ============================================================
INSERT INTO tracks (track_id, artist_id, track_name, duration_sec) VALUES
  ('00000000-0000-0000-0005-000000000001', '00000000-0000-0000-0004-000000000001', 'Şehir Işıkları', 205),
  ('00000000-0000-0000-0005-000000000002', '00000000-0000-0000-0004-000000000002', 'Kırık Saatler',  232),
  ('00000000-0000-0000-0005-000000000003', '00000000-0000-0000-0004-000000000003', 'Yağmur ve Çay',  180),
  ('00000000-0000-0000-0005-000000000004', '00000000-0000-0000-0004-000000000004', 'Midnight Drop',  260),
  ('00000000-0000-0000-0005-000000000005', '00000000-0000-0000-0004-000000000004', 'Neon Loop',      240);

-- ============================================================
-- 4) CHALLENGES  (challenges.csv)
-- ============================================================
INSERT INTO challenges (challenge_id, challenge_name, challenge_type, condition, reward_points, priority, is_active) VALUES
  ('00000000-0000-0000-0003-000000000001', 'Günlük Dinleme',  'DAILY',  'listen_minutes_today >= 30',       60,  5, true),
  ('00000000-0000-0000-0003-000000000002', 'Keşifçi',         'DAILY',  'unique_tracks_today >= 10',       120,  3, true),
  ('00000000-0000-0000-0003-000000000003', 'Playlist Ustası', 'DAILY',  'playlist_additions_today >= 8',   140,  2, true),
  ('00000000-0000-0000-0003-000000000004', 'Paylaşım Bonus',  'DAILY',  'shares_today >= 2',               100,  4, true),
  ('00000000-0000-0000-0003-000000000005', 'Streak Serisi',   'STREAK', 'listen_streak_days >= 3',         200,  1, true),
  ('00000000-0000-0000-0003-000000000006', 'Haftalık Binge',  'WEEKLY', 'listen_minutes_7d >= 500',        350,  6, true),
  ('00000000-0000-0000-0003-000000000007', 'Kupon Avcısı',    'WEEKLY', 'shares_7d >= 6',                  180,  7, true);

-- ============================================================
-- 5) BADGES  (badges.csv)
--    CSV condition "total_points >= 250" → DB bigint = 250
--    CSV level 1/2/3 → BRONZE/SILVER/GOLD
-- ============================================================
INSERT INTO badges (badge_id, badge_name, condition, level) VALUES
  ('00000000-0000-0000-0006-000000000001', 'Bronz Dinleyici',  250,  'BRONZE'),
  ('00000000-0000-0000-0006-000000000002', 'Gümüş Dinleyici',  700,  'SILVER'),
  ('00000000-0000-0000-0006-000000000003', 'Altın Dinleyici',  1200, 'GOLD');

-- ============================================================
-- 6) EVENTS  (activity_events.csv)
-- ============================================================
INSERT INTO events (event_id, user_id, date, listen_minutes, unique_tracks, playlist_additions, shares, top_genre) VALUES
  -- U1 (Ayşe)
  ('00000000-0000-0000-0002-000000000001', '00000000-0000-0000-0001-000000000001', '2026-03-08', 130, 16, 8,  2, 'ELECTRONIC'),
  ('00000000-0000-0000-0002-000000000002', '00000000-0000-0000-0001-000000000001', '2026-03-09', 145, 16, 9,  0, 'ROCK'),
  ('00000000-0000-0000-0002-000000000003', '00000000-0000-0000-0001-000000000001', '2026-03-10', 146, 10, 10, 3, 'ROCK'),
  ('00000000-0000-0000-0002-000000000004', '00000000-0000-0000-0001-000000000001', '2026-03-11', 39,  10, 4,  0, 'POP'),
  ('00000000-0000-0000-0002-000000000005', '00000000-0000-0000-0001-000000000001', '2026-03-12', 152, 15, 11, 0, 'ELECTRONIC'),
  -- U2 (Ali)
  ('00000000-0000-0000-0002-000000000006', '00000000-0000-0000-0001-000000000002', '2026-03-08', 130, 13, 11, 3, 'ROCK'),
  ('00000000-0000-0000-0002-000000000007', '00000000-0000-0000-0001-000000000002', '2026-03-09', 18,  16, 8,  0, 'POP'),
  ('00000000-0000-0000-0002-000000000008', '00000000-0000-0000-0001-000000000002', '2026-03-10', 24,  6,  3,  3, 'POP'),
  ('00000000-0000-0000-0002-000000000009', '00000000-0000-0000-0001-000000000002', '2026-03-11', 133, 8,  7,  3, 'ROCK'),
  ('00000000-0000-0000-0002-000000000010', '00000000-0000-0000-0001-000000000002', '2026-03-12', 147, 6,  10, 1, 'ELECTRONIC'),
  -- U3 (Deniz)
  ('00000000-0000-0000-0002-000000000011', '00000000-0000-0000-0001-000000000003', '2026-03-08', 16,  13, 1,  2, 'LOFI'),
  ('00000000-0000-0000-0002-000000000012', '00000000-0000-0000-0001-000000000003', '2026-03-09', 119, 11, 1,  1, 'LOFI'),
  ('00000000-0000-0000-0002-000000000013', '00000000-0000-0000-0001-000000000003', '2026-03-10', 73,  11, 4,  0, 'POP'),
  ('00000000-0000-0000-0002-000000000014', '00000000-0000-0000-0001-000000000003', '2026-03-11', 159, 15, 1,  2, 'POP'),
  ('00000000-0000-0000-0002-000000000015', '00000000-0000-0000-0001-000000000003', '2026-03-12', 89,  9,  1,  0, 'POP'),
  -- U4 (Mert)
  ('00000000-0000-0000-0002-000000000016', '00000000-0000-0000-0001-000000000004', '2026-03-08', 69,  6,  0,  2, 'ELECTRONIC'),
  ('00000000-0000-0000-0002-000000000017', '00000000-0000-0000-0001-000000000004', '2026-03-09', 116, 9,  1,  3, 'ROCK'),
  ('00000000-0000-0000-0002-000000000018', '00000000-0000-0000-0001-000000000004', '2026-03-10', 84,  8,  1,  1, 'LOFI'),
  ('00000000-0000-0000-0002-000000000019', '00000000-0000-0000-0001-000000000004', '2026-03-11', 18,  9,  12, 0, 'ROCK'),
  ('00000000-0000-0000-0002-000000000020', '00000000-0000-0000-0001-000000000004', '2026-03-12', 78,  14, 1,  0, 'POP'),
  -- U5 (Ece)
  ('00000000-0000-0000-0002-000000000021', '00000000-0000-0000-0001-000000000005', '2026-03-08', 134, 15, 7,  0, 'ROCK'),
  ('00000000-0000-0000-0002-000000000022', '00000000-0000-0000-0001-000000000005', '2026-03-09', 129, 11, 3,  0, 'ELECTRONIC'),
  ('00000000-0000-0000-0002-000000000023', '00000000-0000-0000-0001-000000000005', '2026-03-10', 113, 4,  6,  2, 'ROCK'),
  ('00000000-0000-0000-0002-000000000024', '00000000-0000-0000-0001-000000000005', '2026-03-11', 15,  7,  12, 3, 'LOFI'),
  ('00000000-0000-0000-0002-000000000025', '00000000-0000-0000-0001-000000000005', '2026-03-12', 20,  6,  2,  2, 'POP');

-- ============================================================
-- 7) USER_STATES  (user_state.csv — as_of_date=2026-03-12)
-- ============================================================
INSERT INTO user_states (user_id, listen_minutes_today, unique_tracks_today, playlist_additions_today, shares_today, listen_minutes_7d, shares_7d, unique_tracks_7d, listen_streak_days, total_points) VALUES
  ('00000000-0000-0000-0001-000000000001', 152, 15, 11, 0, 612, 5,  67, 5, 200),
  ('00000000-0000-0000-0001-000000000002', 147, 6,  10, 1, 452, 10, 49, 3, 200),
  ('00000000-0000-0000-0001-000000000003', 89,  9,  1,  0, 456, 5,  59, 4, 200),
  ('00000000-0000-0000-0001-000000000004', 78,  14, 1,  0, 365, 6,  46, 1, 120),
  ('00000000-0000-0000-0001-000000000005', 20,  6,  2,  2, 411, 7,  43, 1, 100);

-- ============================================================
-- 8) CHALLENGE_DECISIONS  (challenge_decisions.csv)
--    CSV: decision_id, user_id, as_of_date, selected_reward_points, reason, timestamp
--    DB:  decision_id, reason, created_at
-- ============================================================
INSERT INTO challenge_decisions (decision_id, reason, created_at) VALUES
  ('00000000-0000-0000-0008-000000002000', 'selected_challenge=C-05; priority=min', '2026-03-12T20:30:00Z'),
  ('00000000-0000-0000-0008-000000002001', 'selected_challenge=C-05; priority=min', '2026-03-12T20:27:00Z'),
  ('00000000-0000-0000-0008-000000002002', 'selected_challenge=C-05; priority=min', '2026-03-12T20:24:00Z'),
  ('00000000-0000-0000-0008-000000002003', 'selected_challenge=C-02; priority=min', '2026-03-12T20:21:00Z'),
  ('00000000-0000-0000-0008-000000002004', 'selected_challenge=C-04; priority=min', '2026-03-12T20:18:00Z');

-- ============================================================
-- 9) CHALLENGE_AWARDS  (challenge_awards.csv → normalize)
--    CSV pipe-separated triggered/suppressed → ayrı junction tablo
--    decision_id link: AW-100x → D-200x (aynı user, aynı tarih)
-- ============================================================
INSERT INTO challenge_awards (award_id, user_id, decision_id, as_of_date, reward_points, created_at) VALUES
  ('00000000-0000-0000-0007-000000001000', '00000000-0000-0000-0001-000000000001', '00000000-0000-0000-0008-000000002000', '2026-03-12', 200, '2026-03-12T20:30:00Z'),
  ('00000000-0000-0000-0007-000000001001', '00000000-0000-0000-0001-000000000002', '00000000-0000-0000-0008-000000002001', '2026-03-12', 200, '2026-03-12T20:27:00Z'),
  ('00000000-0000-0000-0007-000000001002', '00000000-0000-0000-0001-000000000003', '00000000-0000-0000-0008-000000002002', '2026-03-12', 200, '2026-03-12T20:24:00Z'),
  ('00000000-0000-0000-0007-000000001003', '00000000-0000-0000-0001-000000000004', '00000000-0000-0000-0008-000000002003', '2026-03-12', 120, '2026-03-12T20:21:00Z'),
  ('00000000-0000-0000-0007-000000001004', '00000000-0000-0000-0001-000000000005', '00000000-0000-0000-0008-000000002004', '2026-03-12', 100, '2026-03-12T20:18:00Z');

-- ============================================================
-- 10) TRIGGERED_CHALLENGES  (challenge_awards.csv → junction)
--     CSV'deki pipe-separated alanlardan normalize edildi
--     selected_challenge → SELECTED, diğerleri → SUPPRESSED
-- ============================================================
INSERT INTO triggered_challenges (award_id, challenge_id, status) VALUES
  -- AW-1000 (U1): triggered=C-05|C-03|C-02|C-01|C-06, selected=C-05
  ('00000000-0000-0000-0007-000000001000', '00000000-0000-0000-0003-000000000005', 'SELECTED'),
  ('00000000-0000-0000-0007-000000001000', '00000000-0000-0000-0003-000000000003', 'SUPPRESSED'),
  ('00000000-0000-0000-0007-000000001000', '00000000-0000-0000-0003-000000000002', 'SUPPRESSED'),
  ('00000000-0000-0000-0007-000000001000', '00000000-0000-0000-0003-000000000001', 'SUPPRESSED'),
  ('00000000-0000-0000-0007-000000001000', '00000000-0000-0000-0003-000000000006', 'SUPPRESSED'),
  -- AW-1001 (U2): triggered=C-05|C-03|C-01|C-07, selected=C-05
  ('00000000-0000-0000-0007-000000001001', '00000000-0000-0000-0003-000000000005', 'SELECTED'),
  ('00000000-0000-0000-0007-000000001001', '00000000-0000-0000-0003-000000000003', 'SUPPRESSED'),
  ('00000000-0000-0000-0007-000000001001', '00000000-0000-0000-0003-000000000001', 'SUPPRESSED'),
  ('00000000-0000-0000-0007-000000001001', '00000000-0000-0000-0003-000000000007', 'SUPPRESSED'),
  -- AW-1002 (U3): triggered=C-05|C-01, selected=C-05
  ('00000000-0000-0000-0007-000000001002', '00000000-0000-0000-0003-000000000005', 'SELECTED'),
  ('00000000-0000-0000-0007-000000001002', '00000000-0000-0000-0003-000000000001', 'SUPPRESSED'),
  -- AW-1003 (U4): triggered=C-02|C-01|C-07, selected=C-02
  ('00000000-0000-0000-0007-000000001003', '00000000-0000-0000-0003-000000000002', 'SELECTED'),
  ('00000000-0000-0000-0007-000000001003', '00000000-0000-0000-0003-000000000001', 'SUPPRESSED'),
  ('00000000-0000-0000-0007-000000001003', '00000000-0000-0000-0003-000000000007', 'SUPPRESSED'),
  -- AW-1004 (U5): triggered=C-04|C-07, selected=C-04
  ('00000000-0000-0000-0007-000000001004', '00000000-0000-0000-0003-000000000004', 'SELECTED'),
  ('00000000-0000-0000-0007-000000001004', '00000000-0000-0000-0003-000000000007', 'SUPPRESSED');

-- ============================================================
-- 11) POINTS_LEDGER  (points_ledger.csv)
--     source_ref → award UUID'ye dönüştürüldü
-- ============================================================
INSERT INTO points_ledger (ledger_id, user_id, points_delta, source, source_ref, created_at) VALUES
  ('00000000-0000-0000-0009-000000003000', '00000000-0000-0000-0001-000000000001', 200, 'CHALLENGE_REWARD', '00000000-0000-0000-0007-000000001000', '2026-03-12T20:30:00Z'),
  ('00000000-0000-0000-0009-000000003001', '00000000-0000-0000-0001-000000000002', 200, 'CHALLENGE_REWARD', '00000000-0000-0000-0007-000000001001', '2026-03-12T20:27:00Z'),
  ('00000000-0000-0000-0009-000000003002', '00000000-0000-0000-0001-000000000003', 200, 'CHALLENGE_REWARD', '00000000-0000-0000-0007-000000001002', '2026-03-12T20:24:00Z'),
  ('00000000-0000-0000-0009-000000003003', '00000000-0000-0000-0001-000000000004', 120, 'CHALLENGE_REWARD', '00000000-0000-0000-0007-000000001003', '2026-03-12T20:21:00Z'),
  ('00000000-0000-0000-0009-000000003004', '00000000-0000-0000-0001-000000000005', 100, 'CHALLENGE_REWARD', '00000000-0000-0000-0007-000000001004', '2026-03-12T20:18:00Z');

-- ============================================================
-- 12) NOTIFICATIONS  (notifications.csv)
-- ============================================================
INSERT INTO notifications (notification_id, user_id, channel, message, sent_at) VALUES
  ('00000000-0000-0000-000a-000000004000', '00000000-0000-0000-0001-000000000001', 'BiP', 'Kazanım: C-05 tamamlandı. +200 puan.', '2026-03-12T20:30:00Z'),
  ('00000000-0000-0000-000a-000000004001', '00000000-0000-0000-0001-000000000002', 'BiP', 'Kazanım: C-05 tamamlandı. +200 puan.', '2026-03-12T20:27:00Z'),
  ('00000000-0000-0000-000a-000000004002', '00000000-0000-0000-0001-000000000003', 'BiP', 'Kazanım: C-05 tamamlandı. +200 puan.', '2026-03-12T20:24:00Z'),
  ('00000000-0000-0000-000a-000000004003', '00000000-0000-0000-0001-000000000004', 'BiP', 'Kazanım: C-02 tamamlandı. +120 puan.', '2026-03-12T20:21:00Z'),
  ('00000000-0000-0000-000a-000000004004', '00000000-0000-0000-0001-000000000005', 'BiP', 'Kazanım: C-04 tamamlandı. +100 puan.', '2026-03-12T20:18:00Z');

-- ============================================================
-- 13) BADGE_AWARDS  (badge_awards.csv — boş, henüz kimse badge almadı)
-- ============================================================
-- badge_awards boş — CSV'de de boş

COMMIT;

-- ============================================================
-- Doğrulama sorguları
-- ============================================================
SELECT 'users' AS tbl, COUNT(*) FROM users
UNION ALL SELECT 'events', COUNT(*) FROM events
UNION ALL SELECT 'challenges', COUNT(*) FROM challenges
UNION ALL SELECT 'user_states', COUNT(*) FROM user_states
UNION ALL SELECT 'challenge_decisions', COUNT(*) FROM challenge_decisions
UNION ALL SELECT 'challenge_awards', COUNT(*) FROM challenge_awards
UNION ALL SELECT 'triggered_challenges', COUNT(*) FROM triggered_challenges
UNION ALL SELECT 'points_ledger', COUNT(*) FROM points_ledger
UNION ALL SELECT 'badges', COUNT(*) FROM badges
UNION ALL SELECT 'badge_awards', COUNT(*) FROM badge_awards
UNION ALL SELECT 'notifications', COUNT(*) FROM notifications
UNION ALL SELECT 'artists', COUNT(*) FROM artists
UNION ALL SELECT 'tracks', COUNT(*) FROM tracks
ORDER BY tbl;
